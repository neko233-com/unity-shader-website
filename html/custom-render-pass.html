<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå®šä¹‰æ¸²æŸ“ Pass - Unity URP 2022 LTS æ•™ç¨‹</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>URP æ•™ç¨‹</h1>
            </div>
            <nav class="nav-menu" id="navMenu">
                <div class="nav-section">
                    <h3">âš™ï¸ é«˜çº§ä¸»é¢˜</h3>
                    <ul>
                        <li><a href="shader-variants.html">Shader å˜ä½“</a></li>
                        <li><a href="compute-shader.html">Compute Shader</a></li>
                        <li><a href="custom-render-pass.html" class="active">è‡ªå®šä¹‰æ¸²æŸ“ Pass</a></li>
                        <li><a href="performance-optimization.html">æ€§èƒ½ä¼˜åŒ–</a></li>
                    </ul>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <div class="function-page">
                <h1">è‡ªå®šä¹‰æ¸²æŸ“ Pass</h1>
                <p class="subtitle">åœ¨ URP ä¸­å®ç°è‡ªå®šä¹‰æ¸²æŸ“é€»è¾‘</p>

                <div class="section">
                    <h2">ğŸ“š æ¦‚è¿°</h2>
                    <p>è‡ªå®šä¹‰æ¸²æŸ“ Pass å…è®¸åœ¨ URP æ¸²æŸ“æµç¨‹ä¸­æ’å…¥è‡ªå·±çš„æ¸²æŸ“é€»è¾‘ï¼Œå®ç°åå¤„ç†ã€æè¾¹ã€ç‰¹æ®Šæ•ˆæœç­‰ã€‚</p>
                </div>

                <div class="section">
                    <h2">ğŸ’» å®Œæ•´ç¤ºä¾‹ï¼šç°åº¦åå¤„ç†</h2>
                    
                    <h3">1. Shader (GrayscaleShader.shader)</h3>
                    <pre class="shader-code">Shader "Custom/Grayscale"
{
    Properties
    {
        _MainTex("Main Texture", 2D) = "white" {}
        _Intensity("Intensity", Range(0, 1)) = 1
    }
    
    SubShader
    {
        Tags { "RenderType"="Opaque" "RenderPipeline"="UniversalPipeline" }
        
        Pass
        {
            HLSLPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            
            #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"
            
            struct Attributes
            {
                float4 positionOS : POSITION;
                float2 uv : TEXCOORD0;
            };
            
            struct Varyings
            {
                float4 positionCS : SV_POSITION;
                float2 uv : TEXCOORD0;
            };
            
            TEXTURE2D(_MainTex);
            SAMPLER(sampler_MainTex);
            float _Intensity;
            
            Varyings vert(Attributes input)
            {
                Varyings output;
                output.positionCS = TransformObjectToHClip(input.positionOS.xyz);
                output.uv = input.uv;
                return output;
            }
            
            half4 frag(Varyings input) : SV_Target
            {
                half4 color = SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, input.uv);
                half gray = dot(color.rgb, half3(0.299, 0.587, 0.114));
                color.rgb = lerp(color.rgb, gray.xxx, _Intensity);
                return color;
            }
            ENDHLSL
        }
    }
}</pre>

                    <h3">2. Render Feature (GrayscaleFeature.cs)</h3>
                    <pre class="shader-code">using UnityEngine;
using UnityEngine.Rendering;
using UnityEngine.Rendering.Universal;

public class GrayscaleFeature : ScriptableRendererFeature
{
    [System.Serializable]
    public class Settings
    {
        public RenderPassEvent renderPassEvent = RenderPassEvent.AfterRenderingPostProcessing;
        public Material material;
        [Range(0, 1)] public float intensity = 1;
    }
    
    public Settings settings = new Settings();
    private GrayscalePass pass;
    
    public override void Create()
    {
        pass = new GrayscalePass(settings);
    }
    
    public override void AddRenderPasses(ScriptableRenderer renderer, ref RenderingData renderingData)
    {
        if (settings.material != null)
        {
            renderer.EnqueuePass(pass);
        }
    }
    
    public override void SetupRenderPasses(ScriptableRenderer renderer, in RenderingData renderingData)
    {
        pass.Setup(renderer.cameraColorTargetHandle);
    }
}

public class GrayscalePass : ScriptableRenderPass
{
    private GrayscaleFeature.Settings settings;
    private RTHandle source;
    private RTHandle tempRT;
    
    public GrayscalePass(GrayscaleFeature.Settings settings)
    {
        this.settings = settings;
        this.renderPassEvent = settings.renderPassEvent;
    }
    
    public void Setup(RTHandle source)
    {
        this.source = source;
    }
    
    public override void OnCameraSetup(CommandBuffer cmd, ref RenderingData renderingData)
    {
        var desc = renderingData.cameraData.cameraTargetDescriptor;
        desc.depthBufferBits = 0;
        RenderingUtils.ReAllocateIfNeeded(ref tempRT, desc, name: "_GrayscaleTempRT");
    }
    
    public override void Execute(ScriptableRenderContext context, ref RenderingData renderingData)
    {
        if (settings.material == null) return;
        
        CommandBuffer cmd = CommandBufferPool.Get("Grayscale");
        
        settings.material.SetFloat("_Intensity", settings.intensity);
        
        Blit(cmd, source, tempRT, settings.material);
        Blit(cmd, tempRT, source);
        
        context.ExecuteCommandBuffer(cmd);
        CommandBufferPool.Release(cmd);
    }
    
    public override void OnCameraCleanup(CommandBuffer cmd)
    {
        source = null;
    }
    
    public void Dispose()
    {
        tempRT?.Release();
    }
}</pre>
                </div>

                <div class="section">
                    <h2">ğŸ”§ ä½¿ç”¨æ­¥éª¤</h2>
                    
                    <div class="steps">
                        <div class="step">
                            <span class="step-number">1</span>
                            <strong>åˆ›å»º Shader</strong>
                            <p>ç¼–å†™åå¤„ç†æ•ˆæœçš„ Shader</p>
                        </div>
                        
                        <div class="step">
                            <span class="step-number">2</span>
                            <strong>åˆ›å»ºæè´¨</strong>
                            <p>ä½¿ç”¨ Shader åˆ›å»ºæè´¨</p>
                        </div>
                        
                        <div class="step">
                            <span class="step-number">3</span>
                            <strong>åˆ›å»º Feature</strong>
                            <p>ç¼–å†™ ScriptableRendererFeature è„šæœ¬</p>
                        </div>
                        
                        <div class="step">
                            <span class="step-number">4</span>
                            <strong>æ·»åŠ åˆ° Renderer</strong>
                            <p>åœ¨ URP Renderer Asset ä¸­æ·»åŠ  Feature</p>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2">âš ï¸ Unity 2022 æ³¨æ„äº‹é¡¹</h2>
                    
                    <div class="warning-box">
                        <h4">RTHandle æ›¿ä»£ RenderTargetIdentifier</h4>
                        <p>Unity 2022 å¼€å§‹æ¨èä½¿ç”¨ RTHandleã€‚ä½¿ç”¨ <code>RenderingUtils.ReAllocateIfNeeded()</code> ç®¡ç†ä¸´æ—¶ RTã€‚</p>
                    </div>
                    
                    <div class="warning-box">
                        <h4">SetupRenderPasses</h4>
                        <p>è®¾ç½®æ¸²æŸ“ç›®æ ‡åº”åœ¨ <code>SetupRenderPasses</code> è€Œé <code>AddRenderPasses</code> ä¸­è¿›è¡Œã€‚</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/sidebar.js"></script>
    <script src="../js/shader-highlight.js"></script>
    <script src="../js/app.js"></script>
</body>
</html>
